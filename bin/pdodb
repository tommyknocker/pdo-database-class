#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * PDOdb CLI Tool
 *
 * Usage:
 *   vendor/bin/pdodb <command> [subcommand] [arguments] [options]
 *
 * Examples:
 *   vendor/bin/pdodb migrate create create_users_table
 *   vendor/bin/pdodb migrate up
 *   vendor/bin/pdodb schema inspect users
 *   vendor/bin/pdodb query test "SELECT * FROM users"
 *   vendor/bin/pdodb model make User
 */

// Find autoload.php by traversing up directories
// When installed via Composer: vendor/tommyknocker/pdo-database-class/bin/pdodb -> vendor/autoload.php
// When in library development: bin/pdodb -> vendor/autoload.php
$autoloadPath = null;
$dir = __DIR__;

// Try up to 5 levels up
for ($i = 0; $i < 5; $i++) {
    $path = $dir . '/vendor/autoload.php';
    if (file_exists($path)) {
        $autoloadPath = $path;
        break;
    }
    
    $parentDir = dirname($dir);
    if ($parentDir === $dir) {
        // Reached filesystem root
        break;
    }
    $dir = $parentDir;
}

if ($autoloadPath === null) {
    fwrite(STDERR, "Error: Could not find autoload.php. Please run 'composer install'.\n");
    exit(1);
}

require_once $autoloadPath;

use tommyknocker\pdodb\cli\Application;

// Ensure non-interactive mode for tests and CI
if (getenv('PHPUNIT') !== false || getenv('PDODB_NON_INTERACTIVE') !== false) {
    putenv('PDODB_NON_INTERACTIVE=1');
    putenv('PHPUNIT=1');
}

$application = new Application();
exit($application->run($argv));

